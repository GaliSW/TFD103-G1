<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/style.css">
    <script src="../js/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vuex/3.6.2/vuex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <title>商品頁</title>
    <script>

        window.onload = function getproductname(){
            let gachaid = sessionStorage.getItem('productname');
            // console.log(gachaid);

            $.ajax({
                method: "POST",
                url: "../php/product/callproductname.php",
                data: { 
                    GACHAID:gachaid,
                },
                dataType: "json",
                success: function (response) {
                    console.log(response);
                    let username = response[0][1];
                    let gachaid = response[0][2];
                    let price = response[0][3];
                    let title = response[0][12];
                    let img = response[0][14];
                    let content = response[0][16];
                    let PRODUCT_ID = response[0].PRODUCT_ID;
                    let block_product = document.getElementById("flexContainer");
                    let str =`
                    <div class="items -left" id="username" name="${username}">
                        <div class="imgBlock" id="iimgBlock" name='${PRODUCT_ID}'>
                            <img id='${PRODUCT_ID}' src="../image/product/${img}">
                        </div>
                    </div>
                    <div class="items -right">
                        <h1 class="title1">${title}</h1>
                        <p class="introduce">${content}</p>
                        <p class="price">$${price}E</p>

                        <div class="collectForm">
                            <div class="btnBlock1">
                                <button type="${gachaid}" class="collectBtn" name="button" id="myfav" onclick="myfav()"><i class="fas fa-heart"></i>收藏</button>
                                <button type="button" class="changeBtn" name="button" onclick="clickStatus()">交換</button>
                            </div>
                        </div>

                        <div class="buyForm" id="app">
                            <button type="button" class="buyBtn" name="button" onclick="clickStatus1()">購買</button>
                            <component :is="content" id="popUp" @nextacc="myClick" @click-2="myClick2"></component>
                        </div>
                    </div>
                    `;
                    block_product.innerHTML = str;
                },
                error: function (exception) {
                    alert("發生錯誤: " + exception.status);
                }
            });

        }
        


    </script>
</head>
<header></header>

<body>
    @@include('./header.html')
    <main class="allBlock" id="appp">





        <!-- 未登入alert -->
    
        <div id="tologinBlk" class="toGachaBlk none">
            <section class="toGachaHintmaskLayer">
                <div class="toGachaPopUpBox">
                    <div onclick="popCloseX(this)" class="toGachaCloseBtn">
                        x
                    </div>
                    <div class="toGachaPopContent">
                        <p>
                            <i class="far fa-user-circle"></i>&nbsp;您尚未登入會員喔
                        </p>
                    </div>
                    <div class="toGachaConfirmBlk">
                        <button class="bonusConfirmBtn" onclick="popClose(this)">我知道了</button>
                        <button class="bonusConfirmBtn" onclick="tologIn()">登入或註冊～</button>
                    </div>
                </div>
            </section>
        </div>


        <!-- 沒角色alert -->


        <div id="toGachaBlk" class="toGachaBlk none">
            <section class="toGachaHintmaskLayer">
                <div class="toGachaPopUpBox">
                    <div onclick="popCloseX(this)" class="toGachaCloseBtn">
                        x
                    </div>
                    <div class="toGachaPopContent">
                        <p>
                            <i class="far fa-user-circle"></i>&nbsp;您的角色不足，請前往扭蛋
                        </p>
                    </div>
                    <div class="toGachaConfirmBlk">
                        <button class="bonusConfirmBtn" onclick="popClose(this)">我知道了</button>
                        <button class="bonusConfirmBtn" onclick="toGacha()">前往扭蛋</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- 沒有點數alert -->

        <div id="noPointBlk" class="noPointBlk none">
            <section class="noPointHintmaskLayer">
                <div class="noPointPopUpBox">
                    <div onclick="popCloseX(this)" class="noPointCloseBtn">
                        x
                    </div>
                    <div class="noPointPopContent">
                        <p>
                            <i class="far fa-user-circle"></i>&nbsp;您的點數不足，請前往儲值
                        </p>
                    </div>
                    <div class="noPointConfirmBlk">
                        <button class="bonusConfirmBtn" onclick="popClose(this)">我知道了</button>
                        <button class="bonusConfirmBtn" onclick="toPoints()">前往儲值</button>
                    </div>
                </div>
            </section>
        </div>

<!-- 購買成功 -->

       <div id="successBlk" class="noPointBlk none">
            <section class="noPointHintmaskLayer">
                <div class="noPointPopUpBox">
                    <div onclick="popCloseX(this)" class="noPointCloseBtn">
                        x
                    </div>
                    <div class="noPointPopContent">
                        <p>
                            <i class="far fa-user-circle"></i>&nbsp;您已購買成功
                        </p>
                    </div>
                    <div class="noPointConfirmBlk">
                        <button class="bonusConfirmBtn" onclick="popClose(this)">確定</button>
                        <!-- <button class="bonusConfirmBtn" onclick="toPoints()">前往儲值</button> -->
                    </div>
                </div>
            </section>
        </div>




        <section class="sec1">
            <div class="flexContainer" id="flexContainer">
                <!-- <div class="items -left">
                    <div class="imgBlock">
                        <img src="../image/product/role1.png">
                    </div>
                </div> -->
                <!-- <div class="items -right"> -->
                    <!-- <h1 class="title1">小烏龜</h1>
                    <p class="introduce">凡事簡單思考的個性和天生的樂天主義使他對速度沒有絲毫的恐懼感。</p>
                    <p class="price">$250E</p> -->

                    <!-- <div class="collectForm">
                        <div class="btnBlock1">
                            <button type="button" class="collectBtn" name="button" id="myfav" onclick="myfav()"><i class="fas fa-heart"></i>收藏</button>
                            <button type="button" class="changeBtn" name="button" @click=clickStatus()>交換</button>
                        </div>
                    </div>

                    <div class="buyForm" id="app">
                        <button type="button" class="buyBtn" name="button" @click=clickPop()>購買</button>
                        <component :is="content" id="popUp" @nextacc="myClick" @click-2="myClick2"></component>

                    </div>

                </div> -->

            </div>

            <main class="test">
                <template id="=hiddenPopUps">

                    <section class="maskLayer" :class="{'popShow':pop}">

                        <div class="popUpBox one" :class="{'box':one}">
                            <div class="closeBtn" @click=clickClose()>
                                x
                            </div>
                            <div class="popContent12">
                                <p>選擇你要申請交換的角色</p>
                            </div>

                            <div class="roleBlock1Mark">
                                <ul class="roleList1Mark" id="roleList1Mark">
                                    
                                </ul>
                            </div>



                        </div>


                        <div id="popUpBox2" class="popUpBox" :class="{'box':two}">
                            <div class="closeBtn" @click=clickClose()>
                                x
                            </div>
                            <div class="popContent13">
                                <p>確認你想要交換的角色</p>
                            </div>

                            <div class="myRoleBlock">
                                <div class="myRoleP">
                                    <p>我的角色</p>
                                </div>

                                <div class="myRoleImg">
                                    <img id="myRoleImg1" src="../dist/images/product/change/change1.png">
                                </div>

                                <div class="myRoleNameBlock">
                                    <p id="myRoleName1">小烏龜</p>
                                </div>
                            </div>

                            <div class="doubleArrow"><i class="fas fa-arrows-alt-h"></i></div>

                            <div class="yourRoleBlock">
                                <div class="yourRoleP">
                                    <p>對方角色</p>
                                </div>

                                <div class="yourRoleImg">
                                    <img id="yourRoleImg1" src="../dist/images/product/change/change2.png">
                                </div>

                                <div class="yourRoleNameBlock">
                                    <p>羊咩咩</p>
                                </div>
                            </div>

                            <div class="confirmBlk13">
                                <button href="#" class="confirmBtnBack13" @click=toBack()>返回</button>
                                <button href="#" class="confirmBtn13" onclick="toThree()">確定</button>
                            </div>

                        </div>

                        <div class="popUpBox" :class="{'box':three}">
                            <div class="closeBtn" @click=clickClose()>
                                x
                            </div>
                            <div class="popContent14">
                                <p>已送出交換申請，請靜候佳音！</p>
                            </div>

                        </div>
                    </section>

                </template>
            </main>
</section>







        <!-- 雷達圖 -->

        <div class="chart"><canvas id="myChart"></canvas></div>

        <!-- 能力值     -->
        <div class="tableBlock">
            <table>
                <tr>
                    <th>能力值</th>
                    <th>說明</th>
                </tr>

                <tr>
                    <th>加速</th>
                    <td>能力值越高可以越快到達最高速度。</td>
                </tr>

                <tr>
                    <th>抓地</th>
                    <td>能力值越高轉彎幅度就會越小。</td>
                </tr>

                <tr>
                    <th>碰撞</th>
                    <td>能力值越高在惡路上行駛時的減速就會越小。</td>
                </tr>

                <tr>
                    <th>迴避</th>
                    <td>能力值越高越不容易在與對手碰撞時彈飛。</td>
                </tr>

                <tr>
                    <th>道具</th>
                    <td>能力值越高越容易獲得道具。</td>
                </tr>

            </table>

        </div>

    </main>
    @@include('./footer.html')



    <script>
        Vue.component(`maskBlock`, {
            template: `
            <section class="maskBlockM" id="maskBlock">
                <div class="popUpBox abc">
                    <div class="closeBtn" @click="clickClose">
                        x
                    </div>
                    <div class="popContent">
                        <p>是否確認從帳戶扣除 $***點，交易 *****角色?</p>
                    </div>
                    <div class="confirmBlk">
                        <a href="#" class="confirmBtn" @click="next">是</a>
                        <a href="#" class="confirmBtn" @click="clickClose">否</a>
                    </div>
                </div>
            </section>
            `,
            methods: {
                clickClose() {
                    vmm.content = false;
                },
                next() {
                    this.$emit('nextacc', 'maskBlock2');
                }
            },


        });

        Vue.component(`maskBlock2`, {
            template: `
                <section class="maskBlockM">
                    <div class="popUpBox abc">
                        <div  class="closeBtn" @click="clickClose2">
                            x
                        </div>
                        <div class="popContent">
                            <p>您已成功購買</p>
                        </div>
                        <div class="confirmBlk" @click="clickClose2">
                            <a href="#" class="confirmBtn">確定</a>
                        </div>
                    </div>
            </section>
            `,
            methods: {
                clickClose2() {
                    this.$emit('click-2', 'false')
                }
            }
        });

    </script>

    <script>
        let vmm = new Vue({
            el: "#appp",
            data: {
                pop: false,
                one: true,
                two: false,
                three: false,
                content: false,
            },
            methods: {
                clickClose() {
                    vmm.$data.pop = false;
                },
                
                toBack() {
                    vmm.$data.pop = true;
                    vmm.$data.one = true;
                    vmm.$data.two = false;
                    vmm.$data.three = false;
                },
                
                myClick(val) {
                    this.content = val;
                },
                myClick2(r) {
                    this.content = r;
                },
            },
        });


function clickStatus(){
                    $.ajax({
                        method:"POST",
                        url:"../php/LoginCheck.php",
                        data:{},
                        dataType:"text",
                        success:function(response){
                            let tologinBlk = document.getElementById('tologinBlk');
                            if(response == ""){
                                tologinBlk.classList.remove('none');
                                }else{
                                    clickPopp();
                            }
                        }
                    })
                }
function clickPop() {
                    // console.log(e.target)
                    alert();
                    vmm.$data.content = 'maskBlock';
                }


        function clickPopp() {
                $.ajax({
                    method: "POST",
                        url: "../php/product/callChangeRole.php",
                        data: {},
                        dataType: "json",
                        success: function (response) {

                            let roleList1Mark = document.getElementById('roleList1Mark');
                            roleList1Mark.innerHTML= "";
                        

                            $.each(response, function (index, row) {
                                let str =`<li onclick=toTwo(this)>
                                            <div class="imgBlock1Mark" id="imgBlock1Mark" name="${row.GACHA_ID}">
                                                <img src="../image/ROLE/${row.ROLE_IMG}" id="${row.RNAME}" name= "${row.FK_USERNAME}">
                                            </div>
                                        </li>`;
                                roleList1Mark.insertAdjacentHTML("beforeend",str);

                                
                            })
                            let roleList1MarkChild = document.getElementById("roleList1Mark").childNodes[0];
                            console.log(roleList1MarkChild);
                            // 判斷是否有角色
                            let toGachaBlk = document.getElementById('toGachaBlk');
                            if(roleList1MarkChild == null){
                                toGachaBlk.classList.remove('none');
                                vmm.$data.pop = false;
                                vmm.$data.one = false;
                            }

                        },
                        error: function (exception) {
                            alert("數據載入失敗: " + exception.status);
                        }
                    });

                    vmm.$data.pop = true;
                    vmm.$data.one = true;
                    vmm.$data.two = false;
                    vmm.$data.three = false;
            }

        function toTwo(item) {
            vmm.$data.two = true;
            vmm.$data.one = false;
            vmm.$data.three = false;
            
            
            //console.log(item);
            let imgg = item.querySelector("img");
            //console.log(imgg);

//////////// 我的角色圖片

            let imgSrc = imgg.attributes['src'].value;
            let myRoleImg = document.getElementById('myRoleImg1');
            myRoleImg.attributes['src'].value = imgSrc;

//////////// 我的角色名字

            let imgName = imgg.attributes['id'].value;
            let myRoleName = document.getElementById('myRoleName1');
            myRoleName.innerText = imgName;
            //console.log(imgName);

//////////// 我的角色圖片

            let imgBlock = document.getElementsByClassName("imgBlock")[0];
            //console.log(imgBlock);
            let yourImg = imgBlock.querySelector("img");
            //console.log(yourImg);
            yourImgSrc = yourImg.attributes['src'].value;
            let yourRoleImg1 = document.getElementById('yourRoleImg1');
            yourRoleImg1.attributes['src'].value = yourImgSrc;


        }

        function toThree(){

                    vmm.$data.three = true;
                    vmm.$data.one = false;
                    vmm.$data.two = false;

                    let imgBlock1Mark = document.getElementById("imgBlock1Mark");
                    let FK_GACHA_ID = imgBlock1Mark.attributes['name'].value;
                    console.log(FK_GACHA_ID);

                    
                    let iimgBlock = document.getElementById("iimgBlock");
                    let PRODUCT_ID = iimgBlock.attributes['name'].value;
                    console.log(PRODUCT_ID);

                    $.ajax({
                        method: "POST",
                        url: "../php/product/insertByCheck.php",
                        data: {
                            // FK_USERNAME_BUY: FK_USERNAME_BUY,
                            FK_PRODUCT_ID: PRODUCT_ID,
                            FK_GACHA_ID_BUY: FK_GACHA_ID,
                        
                        },
                        dataType: "TEXT",
                        success: function (response) {

                        },
                        error: function (exception) {
                            alert("數據載入失敗: " + exception.status);
                        }
                    });

        }
    </script>
    

<!-- 購買功能fuction -->



<script>
        function clickStatus1(){

            let iimgBlock = document.getElementById("iimgBlock");
            let PRODUCT_ID = iimgBlock.attributes['name'].value;
            console.log(PRODUCT_ID);






            $.ajax({
                method:"POST",
                url:"../php/LoginCheck.php",
                data:{},
                dataType:"text",
                success:function(response){
                    let tologinBlk = document.getElementById('tologinBlk');
                    let nopointBlk = document.getElementById('nopointBlk');
                    if(response == ""){
                        // 沒有登入
                        tologinBlk.classList.remove('none');
                        }else if(response == "true"){
                            $.ajax({
                                    method:"POST",
                                    url:"../php/product/buyRole.php",
                                    data:{ FK_PRODUCT_ID },
                                    dataType:"text",
                                    success:function(response2){
                                        
                                        if(response == "y"){
                                            // 有錢而且成功
                                            buyBtn();
                                            
                                            }else if(response == "no"){
                                                // 沒錢
                                                noPointBlk.classList.remove('none');
                                        }
                                    }
                                })

                    }
                }
            })
        }
</script>











    <script>
            function myfav(){
                let btnName = document.getElementById('myfav').innerText; 
                    if(btnName == "收藏"){
                        let username = document.getElementById('username').attributes['name'].value;
                        let myfavvalue = document.getElementById('myfav').attributes['type'].value;
                        let favchange = document.getElementById('myfav');
                            $.ajax({
                            method: "POST",
                                url: "../php/product/myfav.php",
                                data: {
                                USERNAME:username,
                                PRODUCTID: myfavvalue,
                                },
                                dataType: "text",
                                success: function (response) {
                                    alert('收藏成功');
                                    favchange.classList.remove('collectBtn');
                                    favchange.classList.add('changes');
                                    btnName.innerText = "已收藏"
                                },
                                error: function (exception) {
                                    alert("數據載入失敗: " + exception.status);
                                }
                            });            
                    }
                }
    </script>


<!-- 未登入彈窗function -->

    <script>

        function popClose(item) {
                let blk = item.parentNode.parentNode.parentNode.parentNode;
                blk.classList.add('none');
            }
        function popCloseX(item) {
                let blk = item.parentNode.parentNode.parentNode;
                blk.classList.add('none');
            }
        function tologIn() {
                location.href = "./login.html";
            };
        function toGacha() {
                location.href = "./Gacha.html";
            };
        function toPoints() {
                location.href = "./deposit.html";
            };

    
    
    </script>

    <script src="../js/gacha/chart.js"></script>
</body>

</html>